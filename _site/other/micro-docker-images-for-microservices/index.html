<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Micro Docker Images for Go Microservices &#8211; Things that make my head hurt</title>
<meta name="description" content="Unless you have been living in a cave on a deserted island in the middle of the pacific which has been wrapped in a faraday cage then you are probably talking about microservices and Docker.  This is by far the best topic to get you a pay rise since you pretended to know what Agile is.  In truth however microservices are really important for the way we work, they allow us to develop with independence, keep code contained by its function and if we are using Docker or another container technology, deploy exactly the same application we have just been running on our dev machines.

">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Micro Docker Images for Go Microservices">
<meta name="twitter:description" content="Unless you have been living in a cave on a deserted island in the middle of the pacific which has been wrapped in a faraday cage then you are probably talking about microservices and Docker.  This is by far the best topic to get you a pay rise since you pretended to know what Agile is.  In truth however microservices are really important for the way we work, they allow us to develop with independence, keep code contained by its function and if we are using Docker or another container technology, deploy exactly the same application we have just been running on our dev machines.

">
<meta name="twitter:site" content="@sheriffjackson">
<meta name="twitter:creator" content="@sheriffjackson">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Micro Docker Images for Go Microservices">
<meta property="og:description" content="Unless you have been living in a cave on a deserted island in the middle of the pacific which has been wrapped in a faraday cage then you are probably talking about microservices and Docker.  This is by far the best topic to get you a pay rise since you pretended to know what Agile is.  In truth however microservices are really important for the way we work, they allow us to develop with independence, keep code contained by its function and if we are using Docker or another container technology, deploy exactly the same application we have just been running on our dev machines.

">
<meta property="og:url" content="/other/micro-docker-images-for-microservices/">
<meta property="og:site_name" content="Things that make my head hurt">





<link rel="canonical" href="/other/micro-docker-images-for-microservices/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Things that make my head hurt Feed">
<link rel="author" href="http://plus.google.com/+NicJackson?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="/assets/js/vendor/html5shiv.min.js"></script>
	<script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/">Things that make my head hurt</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
					    
					        
					    
					    <li><a href="/about/" >About</a></li>
					  
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main">
  <div class="article-author-side">
    



	<img src="/images/bio-photo.png" class="bio-photo" alt="Nic Jackson bio photo"></a>

<h3>Nic Jackson</h3>
<p>Geek, Ultrarunner and in my spare time software engineering manager for notonthehighstreet.com.</p>

<a href="http://twitter.com/sheriffjackson" class="author-social" target="_blank"><i class="fa fa-twitter-square"></i> Twitter</a>

<a href="http://plus.google.com/+NicJackson" class="author-social" target="_blank"><i class="fa fa-google-plus-square"></i> Google+</a>
<a href="http://linkedin.com/in/jacksonnic" class="author-social" target="_blank"><i class="fa fa-linkedin-square"></i> LinkedIn</a>


<a href="http://github.com/nicholasjackson" class="author-social" target="_blank"><i class="fa fa-github"></i> Github</a>







  </div>
  <article>
    <div class="headline-wrap">
      
        <h1><a href="/other/micro-docker-images-for-microservices/" rel="bookmark" title="Micro Docker Images for Go Microservices">Micro Docker Images for Go Microservices</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Unless you have been living in a cave on a deserted island in the middle of the pacific which has been wrapped in a faraday cage then you are probably talking about microservices and Docker.  This is by far the best topic to get you a pay rise since you pretended to know what Agile is.  In truth however microservices are really important for the way we work, they allow us to develop with independence, keep code contained by its function and if we are using Docker or another container technology, deploy exactly the same application we have just been running on our dev machines.</p>

<p>When we first get into building Docker images the common approach appears to be to follow the way we used to build virtual machines which is to use Ubuntu, Debian or another big name distribution.  The problem with this is that it produces images that are not that micro, the base image of Ubuntu alone is 187.9MB and most of this is software and libraries which we will never use.</p>

<p><img src="/images/post_images/micro_containers/containers_vs_vms.png" alt="Container Architecture" />  </p>

<p>The main difference between a Container and a VM is that a container runs in process isolation on top of the core OS therefore it does not need its own kernel and a billion other files to run.  What it really needs are executables and libraries and this is the important part of a microcontainer, only install what you are intending to use, do we really need Python for our Go microservice? This is not a difficult problem to solve and let me explain how:</p>

<h2 id="micro-base-box">Micro base box</h2>
<p>Firstly let’s ditch the goto Ubuntu or Debian image you are using as your base box and take a look at something a little lighter.</p>

<p>Alpine Linux (<a href="http://www.alpinelinux.org/">http://www.alpinelinux.org/</a>) is a small linux distribution which when used as a base container results in roughly a 5 MB image size, it is based on the BusyBox (<a href="http://www.busybox.net/about.html">http://www.busybox.net/about.html</a>) distribution of linux which was originally designed for embedded systems.  So why not just use BusyBox? There are quite a few advantages to using Alpine the first is convenience in that Alpine has a package manager <code>apk</code> which can simplify some of your container maintenance and the second is that the kernel has been patched with PaX (<a href="https://www.grsecurity.net/">https://www.grsecurity.net/</a>) which protects against quite a large number of 0 day vulnerabilities.</p>

<p>You can see from the table below, all this only adds 4.1 MB to the size of busybox but for this convenience I think is well worth the cost.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">REPOSITORY                             VIRTUAL SIZE
ubuntu                                 187.90 MB  
nicholasjackson/microservice-basebox    15.82 MB  
alpine                                   5.24 MB  
busybox                                  1.10 MB</code></pre></div>

<h2 id="compiling-go-applications-for-alpine-linux">Compiling Go applications for Alpine Linux</h2>
<p>One of the advantages of working with Go for your microservices is the way that it creates compiled binaries which require no framework or runtime dependancies, this works really nicely with Alpine however we do need to remember that since it is a light weight distribution it does not have all the C libraries which would be normally expected for a standard dynamically linked Go binary.  Fortunately there is a simple work around which is to disable cgo when we compile and statically link the application.  We also need to tell the compiler to rebuild all the packages we are using to ensure they are also rebuilt and statically linked.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> go build -a -installsuffix cgo .</code></pre></div>

<p>Lets take a look at this in a little more detail:<br />
<code>CGO_ENABLED=0</code> is a flag to tell the build system to ignore cgo and to statically link the binary<br />
<code>-a</code> is the flag to force rebuilding of packages that are already up-to-date.<br />
<code>-installsuffix cgo</code> adds a suffix to use in the name of the package installation directory, this keeps output separate from default builds variants.  </p>

<h2 id="running-your-application">Running your application</h2>
<p>That gives us our binary what about your config, if you are building a microservice architecture then you are most likely going to be using Consul (<a href="https://www.consul.io/">https://www.consul.io/</a>), if not you should really check it out as it is amazing.  For the purpose of this article I am going to assume that you are and therefore you are also using Consul template (<a href="https://github.com/hashicorp/consul-template">https://github.com/hashicorp/consul-template</a>) to populate your config file and possibly restart your application when the config changes, so we will need that too.</p>

<p>But we need to keep both of those things running on the container for this we would usually start it with a daemon runner like Supervisor (<a href="http://supervisord.org/">http://supervisord.org/</a>).  Unfortunately this uses Python which we do not want on our light weight linux box so instead we will use Skaware S6 (<a href="http://skarnet.org/software/s6/">http://skarnet.org/software/s6/</a>).</p>

<p>S6 is a simple and effective application, it is started using the s6-svscan application with the parameter of a config folder <code>$ s6-svscan /etc/s6</code>.  If you look at the example config folder in my basebox (<a href="https://hub.docker.com/r/nicholasjackson/microservice-basebox/">https://hub.docker.com/r/nicholasjackson/microservice-basebox/</a>) repository you will see that it contains multiple folders containing a bunch of shell scripts.</p>

<h3 id="s6-svscan">.s6-svscan</h3>
<p>This folder contains two scripts “crash” and “finish”, crash is called when one of the applications s6 is running terminate with an error, finish is called when the s6 process shuts down.</p>

<h3 id="app">app</h3>
<p>This folder contains two scripts “run” and “finish”, run is the script to start your main service and will typically be the execution path for your go binary.  Finish is where you can put any activities to run when the application shuts down.</p>

<h3 id="consul-template">consul-template</h3>
<p>This folder also contains the same two scripts but this time it is for the consul-template application, consul-template generates the config file used by our microservice from information stored in the Consul server.  Since this continually monitors the information in Consul this application must also be running for the life cycle of our microservice so we need to use s6 to monitor it and keep it alive.</p>

<h2 id="docker-base-image">Docker Base Image</h2>
<p>For convenience I have created a base Docker image based on Alpine with Skaware S6 and Consul Template installed (<a href="https://hub.docker.com/r/nicholasjackson/microservice-basebox/">https://hub.docker.com/r/nicholasjackson/microservice-basebox/</a>), all in the new base box will be a tiny 15.82 MB.  By the time you add your bloated application code (yes I am being facetious) the total image will be roughly 30 MB which is a staggering 13% of the size should you have chosen the Ubuntu base box.</p>

<h2 id="conclusion">Conclusion</h2>
<p>In this article I have mainly discussed Go applications but you can apply the techniques to Ruby or Python.  Alpine “apk” already has packages for both of these languages and with a bit of effort you could probably get a Java JRE on there.</p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          



	<img src="/images/bio-photo.png" class="bio-photo" alt="Nic Jackson bio photo"></a>

<h3>Nic Jackson</h3>
<p>Geek, Ultrarunner and in my spare time software engineering manager for notonthehighstreet.com.</p>

<a href="http://twitter.com/sheriffjackson" class="author-social" target="_blank"><i class="fa fa-twitter-square"></i> Twitter</a>

<a href="http://plus.google.com/+NicJackson" class="author-social" target="_blank"><i class="fa fa-google-plus-square"></i> Google+</a>
<a href="http://linkedin.com/in/jacksonnic" class="author-social" target="_blank"><i class="fa fa-linkedin-square"></i> LinkedIn</a>


<a href="http://github.com/nicholasjackson" class="author-social" target="_blank"><i class="fa fa-github"></i> Github</a>







        </div>
        <p class="byline"><strong>Micro Docker Images for Go Microservices</strong> was published on <time datetime="2015-12-01T14:00:00+00:00">December 01, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="/zombie-apocalypse/" title="Software Engineering will be responsible for impending Zombie apocalypse">Software Engineering will be responsible for impending Zombie apocalypse</a></li>
    
      <li><a href="/the-search-for-self-organising-teams/" title="The Last Crusade: The Search for self organising teams">The Last Crusade: The Search for self organising teams</a></li>
    
      <li><a href="/other/why-you-need-anarchy-part1/" title="Why you need anarchy - Part 1: Anarchy Explained">Why you need anarchy - Part 1: Anarchy Explained</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  <footer>
    <div class="google-ads">
  <!-- 320 x 50 ad -->
  <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
       style="display:inline-block;width:320px;height:50px"
       data-ad-client=""
       data-ad-slot=""></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div><!-- /.google-ads -->

<span>&copy; 2015 Nic Jackson. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-53659420-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thingsthatmakemyheadhurt'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</body>
</html>
